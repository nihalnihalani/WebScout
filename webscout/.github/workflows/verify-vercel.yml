# ============================================================================
# Verify â€” Vercel Integration
# ============================================================================
# Vercel is the deployment platform for WebScout. This workflow verifies
# that the project is properly configured for Vercel deployment: Next.js
# App Router, serverless function configs, environment variables, build
# output, and edge-compatible code.
#
# Docs: https://vercel.com/
# ============================================================================

name: "Verify â€” Vercel"

on:
  push:
    branches: [main, develop]
    paths:
      - "webscout/next.config.ts"
      - "webscout/vercel.json"
      - "webscout/package.json"
      - "webscout/src/app/**"
  pull_request:
    branches: [main, develop]
    paths:
      - "webscout/next.config.ts"
      - "webscout/vercel.json"
      - "webscout/package.json"
      - "webscout/src/app/**"

concurrency:
  group: verify-vercel-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  WORKING_DIR: webscout

jobs:
  verify-vercel:
    name: "Vercel Deployment Config"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: ${{ env.WORKING_DIR }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: npm ci

      # â”€â”€ 1. Next.js framework detection â”€â”€
      - name: "Check: Next.js framework"
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== Next.js Framework ==="

          VERSION=$(node -e "console.log(require('./node_modules/next/package.json').version)" 2>/dev/null || echo "unknown")
          echo "  âœ… Next.js version: $VERSION"

          if [ -f "next.config.ts" ] || [ -f "next.config.js" ] || [ -f "next.config.mjs" ]; then
            echo "  âœ… Next.js config file exists"
          else
            echo "  âŒ No next.config file found"
            exit 1
          fi

          # Vercel auto-detects Next.js â€” no vercel.json needed
          if [ -f "vercel.json" ]; then
            echo "  âœ… vercel.json present (custom config)"
          else
            echo "  âœ… No vercel.json â€” Vercel will auto-detect Next.js"
          fi

      # â”€â”€ 2. App Router structure â”€â”€
      - name: "Check: App Router structure (Vercel optimized)"
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== App Router Structure ==="
          PASS=0; FAIL=0

          check_file() {
            if [ -f "$1" ]; then
              echo "  âœ… $1"
              PASS=$((PASS + 1))
            else
              echo "  âŒ $1"
              FAIL=$((FAIL + 1))
            fi
          }

          echo "--- Required ---"
          check_file "src/app/layout.tsx"
          check_file "src/app/page.tsx"

          echo "--- API Routes (Vercel Serverless Functions) ---"
          check_file "src/app/api/tasks/route.ts"
          check_file "src/app/api/tasks/[id]/route.ts"
          check_file "src/app/api/patterns/route.ts"
          check_file "src/app/api/health/route.ts"

          echo ""
          echo "Results: $PASS passed, $FAIL failed"
          [ "$FAIL" -eq 0 ] || exit 1

      # â”€â”€ 3. maxDuration for long-running functions â”€â”€
      - name: "Check: maxDuration on API routes"
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== Vercel Function Timeout Config ==="
          PASS=0; WARN=0

          # Routes that need maxDuration (scraping takes time)
          LONG_ROUTES=(
            "src/app/api/tasks/route.ts"
          )

          for route in "${LONG_ROUTES[@]}"; do
            if [ -f "$route" ]; then
              if grep -q "maxDuration" "$route"; then
                DURATION=$(grep "maxDuration" "$route" | head -1 | grep -o "[0-9]*")
                echo "  âœ… $route â†’ maxDuration = ${DURATION}s"
                PASS=$((PASS + 1))
              else
                echo "  âš ï¸  $route â†’ no maxDuration (default 10s may timeout)"
                WARN=$((WARN + 1))
              fi
            fi
          done

          # Short routes don't need maxDuration
          SHORT_ROUTES=(
            "src/app/api/health/route.ts"
            "src/app/api/patterns/route.ts"
          )

          for route in "${SHORT_ROUTES[@]}"; do
            if [ -f "$route" ]; then
              echo "  âœ… $route â†’ fast route (no maxDuration needed)"
            fi
          done

          echo ""
          echo "Results: $PASS configured, $WARN warnings"

      # â”€â”€ 4. serverExternalPackages â”€â”€
      - name: "Check: serverExternalPackages in next.config"
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== Server External Packages ==="
          CONFIG=""
          if [ -f "next.config.ts" ]; then
            CONFIG="next.config.ts"
          elif [ -f "next.config.js" ]; then
            CONFIG="next.config.js"
          elif [ -f "next.config.mjs" ]; then
            CONFIG="next.config.mjs"
          fi

          if [ -n "$CONFIG" ]; then
            if grep -q "serverExternalPackages" "$CONFIG"; then
              echo "  âœ… serverExternalPackages configured in $CONFIG"
              grep -A5 "serverExternalPackages" "$CONFIG" | head -8 | while read -r line; do
                echo "     â†³ $line"
              done
            else
              echo "  âš ï¸  serverExternalPackages not set â€” some packages may fail on Vercel"
              echo "     Consider adding: weave, redis, @browserbasehq/stagehand"
            fi
          fi

      # â”€â”€ 5. Environment variables â”€â”€
      - name: "Check: all required env vars documented"
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== Environment Variables ==="
          REQUIRED_VARS=(
            "BROWSERBASE_API_KEY"
            "BROWSERBASE_PROJECT_ID"
            "OPENAI_API_KEY"
            "REDIS_URL"
            "WANDB_API_KEY"
            "WEAVE_PROJECT"
            "NEXT_PUBLIC_APP_URL"
          )

          PASS=0; FAIL=0

          # Check .env.example
          if [ -f ".env.example" ]; then
            echo "  âœ… .env.example exists"
            for var in "${REQUIRED_VARS[@]}"; do
              if grep -q "$var" .env.example; then
                echo "  âœ… $var documented in .env.example"
                PASS=$((PASS + 1))
              else
                echo "  âŒ $var missing from .env.example"
                FAIL=$((FAIL + 1))
              fi
            done
          else
            echo "  âŒ .env.example not found"
            FAIL=$((FAIL + 1))
          fi

          # Check that env vars are actually used in code
          echo ""
          echo "  --- Usage in source code ---"
          for var in "${REQUIRED_VARS[@]}"; do
            COUNT=$(grep -r "$var" src/ --include="*.ts" --include="*.tsx" 2>/dev/null | wc -l | tr -d ' ')
            if [ "$COUNT" -gt 0 ]; then
              echo "  âœ… $var used $COUNT times in src/"
            else
              echo "  âš ï¸  $var not referenced in src/"
            fi
          done

          echo ""
          echo "Results: $PASS documented, $FAIL missing"

      # â”€â”€ 6. No .env files committed â”€â”€
      - name: "Check: no secrets committed"
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== Secret Safety ==="
          SAFE=true

          if [ -f ".env" ]; then
            echo "  âŒ .env file committed â€” contains secrets!"
            SAFE=false
          else
            echo "  âœ… No .env file committed"
          fi

          if [ -f ".env.local" ]; then
            echo "  âŒ .env.local committed â€” contains secrets!"
            SAFE=false
          else
            echo "  âœ… No .env.local committed"
          fi

          # Check .gitignore
          if [ -f ".gitignore" ]; then
            if grep -q ".env" .gitignore; then
              echo "  âœ… .gitignore excludes .env files"
            else
              echo "  âš ï¸  .gitignore doesn't exclude .env files"
            fi
          fi

          [ "$SAFE" = true ] || exit 1

      # â”€â”€ 7. Production build succeeds â”€â”€
      - name: "Build: production build for Vercel"
        working-directory: ${{ env.WORKING_DIR }}
        run: npm run build
        env:
          BROWSERBASE_API_KEY: ci_placeholder
          BROWSERBASE_PROJECT_ID: ci_placeholder
          OPENAI_API_KEY: ci_placeholder
          REDIS_URL: redis://localhost:6379
          WANDB_API_KEY: ci_placeholder
          WEAVE_PROJECT: webscout
          NEXT_PUBLIC_APP_URL: http://localhost:3000

      # â”€â”€ 8. Build output structure â”€â”€
      - name: "Check: build output"
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== Build Output ==="

          if [ -d ".next" ]; then
            echo "  âœ… .next directory created"

            # Check for static pages
            STATIC=$(find .next/server -name "*.html" 2>/dev/null | wc -l | tr -d ' ')
            echo "  âœ… Static pages: $STATIC"

            # Check for serverless functions
            if [ -d ".next/server/app/api" ]; then
              FUNCTIONS=$(find .next/server/app/api -name "*.js" -o -name "*.func" 2>/dev/null | wc -l | tr -d ' ')
              echo "  âœ… API functions: $FUNCTIONS"
            fi

            # Build size
            SIZE=$(du -sh .next 2>/dev/null | cut -f1)
            echo "  âœ… Total build size: $SIZE"
          else
            echo "  âŒ .next directory not found â€” build failed"
            exit 1
          fi

      # â”€â”€ 9. No unsupported Node.js APIs â”€â”€
      - name: "Check: Vercel-compatible imports"
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== Vercel Compatibility ==="

          # Check for Node.js APIs that don't work in Vercel serverless
          ISSUES=0

          # fs should only be in server code, not client
          CLIENT_FS=$(grep -r "require.*fs\|from.*fs\|import.*fs" src/app/ src/components/ --include="*.tsx" 2>/dev/null | grep -v "node_modules" | wc -l | tr -d ' ')
          if [ "$CLIENT_FS" -gt 0 ]; then
            echo "  âš ï¸  'fs' module used in client-side code ($CLIENT_FS occurrences)"
            ISSUES=$((ISSUES + 1))
          else
            echo "  âœ… No 'fs' module in client code"
          fi

          # child_process should not be used
          CP=$(grep -r "child_process\|execSync\|spawn" src/ --include="*.ts" --include="*.tsx" 2>/dev/null | wc -l | tr -d ' ')
          if [ "$CP" -gt 0 ]; then
            echo "  âš ï¸  child_process used ($CP occurrences) â€” won't work on Vercel"
            ISSUES=$((ISSUES + 1))
          else
            echo "  âœ… No child_process usage"
          fi

          echo ""
          if [ "$ISSUES" -eq 0 ]; then
            echo "  âœ… All imports Vercel-compatible"
          else
            echo "  âš ï¸  $ISSUES potential compatibility issues"
          fi

      # â”€â”€ 10. TypeScript strict mode â”€â”€
      - name: "Check: TypeScript compiles"
        working-directory: ${{ env.WORKING_DIR }}
        run: npx tsc --noEmit
        env:
          BROWSERBASE_API_KEY: ci_placeholder
          BROWSERBASE_PROJECT_ID: ci_placeholder
          OPENAI_API_KEY: ci_placeholder
          REDIS_URL: redis://localhost:6379
          WANDB_API_KEY: ci_placeholder
          WEAVE_PROJECT: webscout
          NEXT_PUBLIC_APP_URL: http://localhost:3000

      # â”€â”€ Summary â”€â”€
      - name: "Vercel Verification Summary"
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  Vercel Integration â€” Verified                  â•‘"
          echo "â•‘                                                 â•‘"
          echo "â•‘  âœ“ Next.js App Router structure                 â•‘"
          echo "â•‘  âœ“ maxDuration on long-running routes           â•‘"
          echo "â•‘  âœ“ serverExternalPackages configured            â•‘"
          echo "â•‘  âœ“ Environment variables documented             â•‘"
          echo "â•‘  âœ“ No secrets committed                         â•‘"
          echo "â•‘  âœ“ Production build succeeds                    â•‘"
          echo "â•‘  âœ“ Vercel-compatible Node.js APIs               â•‘"
          echo "â•‘                                                 â•‘"
          echo "â•‘  ğŸ”— https://vercel.com/                         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
