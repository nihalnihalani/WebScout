# ============================================================================
# Verify â€” Weights & Biases (Weave) Integration
# ============================================================================
# Weave is the LLM tracing & observability platform from W&B.
# This workflow verifies that every major agent operation is traced via Weave,
# that weave.op() wrappers are used correctly, and that the tracing
# infrastructure is wired up end-to-end.
#
# Docs: https://wandb.me/use-weave
# ============================================================================

name: "Verify â€” Weave (W&B)"

on:
  push:
    branches: [main, develop]
    paths:
      - "webscout/src/lib/tracing/**"
      - "webscout/src/lib/engine/**"
      - "webscout/src/lib/redis/vectors.ts"
      - "webscout/src/lib/embeddings/**"
      - "webscout/package.json"
  pull_request:
    branches: [main, develop]
    paths:
      - "webscout/src/lib/tracing/**"
      - "webscout/src/lib/engine/**"
      - "webscout/src/lib/redis/vectors.ts"
      - "webscout/src/lib/embeddings/**"
      - "webscout/package.json"

concurrency:
  group: verify-weave-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  WORKING_DIR: webscout

jobs:
  verify-weave:
    name: "Weave Integration"
    runs-on: ubuntu-latest
    timeout-minutes: 8

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: ${{ env.WORKING_DIR }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: npm ci

      # â”€â”€ 1. Package installed â”€â”€
      - name: "Check: weave package installed"
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== Weave Package ==="
          if node -e "require('weave')" 2>/dev/null; then
            echo "  âœ… 'weave' package is importable"
          else
            echo "  âŒ 'weave' package cannot be imported"
            exit 1
          fi

          if grep -q '"weave"' package.json; then
            VERSION=$(node -e "console.log(require('./node_modules/weave/package.json').version)" 2>/dev/null || echo "unknown")
            echo "  âœ… weave@$VERSION in package.json"
          else
            echo "  âŒ 'weave' not in package.json dependencies"
            exit 1
          fi

      # â”€â”€ 2. Tracing module exists â”€â”€
      - name: "Check: tracing module files"
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== Tracing Module ==="
          PASS=0; FAIL=0

          check_file() {
            if [ -f "$1" ]; then
              echo "  âœ… $1"
              PASS=$((PASS + 1))
            else
              echo "  âŒ $1 â€” NOT FOUND"
              FAIL=$((FAIL + 1))
            fi
          }

          check_file "src/lib/tracing/weave.ts"
          check_file "src/lib/tracing/trace-context.ts"

          echo ""
          echo "Results: $PASS passed, $FAIL failed"
          [ "$FAIL" -eq 0 ] || exit 1

      # â”€â”€ 3. weave.init() called â”€â”€
      - name: "Check: weave.init() initialization"
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== Weave Initialization ==="
          if grep -rq "weave\.init\|weave\.login\|init.*weave" src/lib/tracing/; then
            echo "  âœ… weave.init() found in tracing module"
            grep -rn "weave\.init\|init.*weave" src/lib/tracing/ | head -5 | while read -r line; do
              echo "     â†³ $line"
            done
          else
            echo "  âŒ weave.init() not found â€” tracing won't work"
            exit 1
          fi

      # â”€â”€ 4. weave.op() wrappers used â”€â”€
      - name: "Check: weave.op() function wrappers"
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== weave.op() Usage ==="
          OP_COUNT=$(grep -r "weave\.op\|weave\.op(" src/ --include="*.ts" --include="*.tsx" | wc -l | tr -d ' ')

          if [ "$OP_COUNT" -gt 0 ]; then
            echo "  âœ… weave.op() used $OP_COUNT times across the codebase"
            echo ""
            echo "  Traced functions:"
            grep -rn "weave\.op(" src/ --include="*.ts" --include="*.tsx" | while read -r line; do
              echo "     â†³ $line"
            done
          else
            echo "  âŒ weave.op() not used anywhere â€” no functions are traced"
            exit 1
          fi

      # â”€â”€ 5. Key operations are traced â”€â”€
      - name: "Check: critical operations have Weave tracing"
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== Traced Operations ==="
          PASS=0; WARN=0

          check_traced() {
            FILE="$1"
            NAME="$2"
            if [ -f "$FILE" ]; then
              if grep -q "weave\|op(" "$FILE"; then
                echo "  âœ… $NAME ($FILE) â€” has Weave tracing"
                PASS=$((PASS + 1))
              else
                echo "  âš ï¸  $NAME ($FILE) â€” no Weave tracing found"
                WARN=$((WARN + 1))
              fi
            fi
          }

          check_traced "src/lib/engine/scraper.ts" "Learning scrape loop"
          check_traced "src/lib/engine/recovery.ts" "Recovery strategies"
          check_traced "src/lib/redis/vectors.ts" "Vector search"
          check_traced "src/lib/embeddings/openai.ts" "Embedding generation"
          check_traced "src/lib/browser/session.ts" "Browser session"
          check_traced "src/lib/engine/pattern-extractor.ts" "Pattern extraction"

          echo ""
          echo "Results: $PASS traced, $WARN untraced"

      # â”€â”€ 6. Screenshot & DOM capture â”€â”€
      - name: "Check: trace context captures screenshots & DOM"
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== Trace Context ==="
          FILE="src/lib/tracing/trace-context.ts"

          if [ ! -f "$FILE" ]; then
            echo "  âŒ trace-context.ts not found"
            exit 1
          fi

          FEATURES=0
          if grep -q "screenshot\|Screenshot\|captureScreenshot" "$FILE"; then
            echo "  âœ… Screenshot capture function"
            FEATURES=$((FEATURES + 1))
          else
            echo "  âŒ No screenshot capture"
          fi

          if grep -q "DOM\|dom\|captureDOMSnapshot\|innerHTML\|content()" "$FILE"; then
            echo "  âœ… DOM snapshot capture function"
            FEATURES=$((FEATURES + 1))
          else
            echo "  âŒ No DOM snapshot capture"
          fi

          if grep -q "export" "$FILE"; then
            echo "  âœ… Functions are exported"
            FEATURES=$((FEATURES + 1))
          fi

          echo ""
          echo "  Features: $FEATURES/3"
          [ "$FEATURES" -ge 2 ] || exit 1

      # â”€â”€ 7. wrapOpenAI integration â”€â”€
      - name: "Check: Weave wraps OpenAI client"
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== Weave + OpenAI Integration ==="
          if grep -rq "wrapOpenAI\|weave.*OpenAI\|weave.*openai" src/ --include="*.ts"; then
            echo "  âœ… weave.wrapOpenAI() found â€” OpenAI calls are traced"
            grep -rn "wrapOpenAI" src/ --include="*.ts" | head -3 | while read -r line; do
              echo "     â†³ $line"
            done
          else
            echo "  âš ï¸  weave.wrapOpenAI() not found â€” OpenAI calls won't appear in traces"
          fi

      # â”€â”€ 8. Environment variables â”€â”€
      - name: "Check: Weave env vars referenced"
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== Environment Variables ==="
          PASS=0; FAIL=0

          if grep -rq "WANDB_API_KEY" src/ .env* 2>/dev/null; then
            echo "  âœ… WANDB_API_KEY referenced"
            PASS=$((PASS + 1))
          else
            echo "  âŒ WANDB_API_KEY not referenced anywhere"
            FAIL=$((FAIL + 1))
          fi

          if grep -rq "WEAVE_PROJECT" src/ .env* 2>/dev/null; then
            echo "  âœ… WEAVE_PROJECT referenced"
            PASS=$((PASS + 1))
          else
            echo "  âŒ WEAVE_PROJECT not referenced anywhere"
            FAIL=$((FAIL + 1))
          fi

          echo ""
          echo "Results: $PASS passed, $FAIL failed"

      # â”€â”€ 9. Nested trace structure â”€â”€
      - name: "Check: nested trace tree structure"
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== Nested Trace Tree ==="
          echo "  Checking that traced functions call other traced functions"
          echo "  (creates the nested tree visible in W&B dashboard)"
          echo ""

          # The scraper should call traced sub-functions
          FILE="src/lib/engine/scraper.ts"
          if [ -f "$FILE" ]; then
            CALLS=0
            for fn in "searchSimilarPatterns\|vectorSearch" "createSession\|createStagehand" "captureScreenshot" "storePattern" "attemptRecovery\|recovery" "extractPattern"; do
              if grep -q "$fn" "$FILE"; then
                CALLS=$((CALLS + 1))
              fi
            done
            echo "  âœ… scraper.ts calls $CALLS/6 traced sub-operations"
            if [ "$CALLS" -ge 3 ]; then
              echo "  âœ… Sufficient nesting for meaningful trace tree"
            else
              echo "  âš ï¸  Trace tree may be shallow â€” consider tracing more sub-operations"
            fi
          fi

      # â”€â”€ 10. TypeScript compilation â”€â”€
      - name: "Check: TypeScript compiles with Weave types"
        working-directory: ${{ env.WORKING_DIR }}
        run: npx tsc --noEmit
        env:
          BROWSERBASE_API_KEY: ci_placeholder
          BROWSERBASE_PROJECT_ID: ci_placeholder
          OPENAI_API_KEY: ci_placeholder
          REDIS_URL: redis://localhost:6379
          WANDB_API_KEY: ci_placeholder
          WEAVE_PROJECT: webscout
          NEXT_PUBLIC_APP_URL: http://localhost:3000

      # â”€â”€ Summary â”€â”€
      - name: "Weave Verification Summary"
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  Weave (W&B) Integration â€” Verified            â•‘"
          echo "â•‘                                                 â•‘"
          echo "â•‘  âœ“ weave package installed                      â•‘"
          echo "â•‘  âœ“ weave.init() initializes tracing             â•‘"
          echo "â•‘  âœ“ weave.op() wraps key functions               â•‘"
          echo "â•‘  âœ“ Screenshots & DOM captured in traces         â•‘"
          echo "â•‘  âœ“ OpenAI calls wrapped for tracing             â•‘"
          echo "â•‘  âœ“ Nested trace tree for W&B dashboard          â•‘"
          echo "â•‘                                                 â•‘"
          echo "â•‘  ğŸ”— https://wandb.me/use-weave                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
