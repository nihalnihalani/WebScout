# ============================================================================
# Verify â€” Browserbase & Stagehand Integration
# ============================================================================
# Browserbase provides cloud browser infrastructure. Stagehand provides the
# AI-powered automation SDK. Together they power WebScout's web scraping
# with act(), extract(), agent(), and observe() capabilities.
#
# Docs: https://www.stagehand.dev/
# ============================================================================

name: "Verify â€” Browserbase & Stagehand"

on:
  push:
    branches: [main, develop]
    paths:
      - "webscout/src/lib/browser/**"
      - "webscout/src/lib/engine/**"
      - "webscout/package.json"
  pull_request:
    branches: [main, develop]
    paths:
      - "webscout/src/lib/browser/**"
      - "webscout/src/lib/engine/**"
      - "webscout/package.json"

concurrency:
  group: verify-browserbase-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  WORKING_DIR: webscout

jobs:
  verify-browserbase:
    name: "Browserbase & Stagehand Integration"
    runs-on: ubuntu-latest
    timeout-minutes: 8

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: ${{ env.WORKING_DIR }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: npm ci

      # â”€â”€ 1. Packages installed â”€â”€
      - name: "Check: Browserbase & Stagehand packages"
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== Browserbase & Stagehand Packages ==="
          PASS=0; FAIL=0

          check_pkg() {
            if node -e "require('$1')" 2>/dev/null; then
              VERSION=$(node -e "try{console.log(require('./node_modules/$1/package.json').version)}catch(e){console.log('unknown')}" 2>/dev/null)
              echo "  âœ… $1@$VERSION"
              PASS=$((PASS + 1))
            else
              echo "  âŒ $1 not importable"
              FAIL=$((FAIL + 1))
            fi
          }

          check_pkg "@browserbasehq/stagehand"
          check_pkg "@browserbasehq/sdk"
          check_pkg "zod"

          echo ""
          echo "Results: $PASS passed, $FAIL failed"
          [ "$FAIL" -eq 0 ] || exit 1

      # â”€â”€ 2. Browser module files â”€â”€
      - name: "Check: browser module files exist"
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== Browser Module ==="
          PASS=0; FAIL=0

          check_file() {
            if [ -f "$1" ]; then
              echo "  âœ… $1"
              PASS=$((PASS + 1))
            else
              echo "  âŒ $1 â€” NOT FOUND"
              FAIL=$((FAIL + 1))
            fi
          }

          check_file "src/lib/browser/session.ts"
          check_file "src/lib/browser/stagehand-client.ts"

          echo ""
          echo "Results: $PASS passed, $FAIL failed"
          [ "$FAIL" -eq 0 ] || exit 1

      # â”€â”€ 3. Stagehand constructor config â”€â”€
      - name: "Check: Stagehand constructor uses BROWSERBASE env"
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== Stagehand Configuration ==="
          PASS=0; FAIL=0

          # Check stagehand-client.ts or wherever Stagehand is instantiated
          FILES=$(grep -rl "Stagehand\|stagehand" src/lib/ --include="*.ts" 2>/dev/null)

          if [ -z "$FILES" ]; then
            echo "  âŒ No Stagehand references found in src/lib/"
            exit 1
          fi

          echo "  Files referencing Stagehand:"
          for f in $FILES; do
            echo "     â†³ $f"
          done

          # Check for BROWSERBASE env
          if grep -rq "BROWSERBASE\|env.*BROWSERBASE\|env:.*BROWSERBASE" src/lib/browser/ 2>/dev/null; then
            echo "  âœ… env: 'BROWSERBASE' configured"
            PASS=$((PASS + 1))
          else
            echo "  âŒ env: 'BROWSERBASE' not found in browser module"
            FAIL=$((FAIL + 1))
          fi

          # Check for API key env vars
          if grep -rq "BROWSERBASE_API_KEY" src/ 2>/dev/null; then
            echo "  âœ… BROWSERBASE_API_KEY referenced"
            PASS=$((PASS + 1))
          else
            echo "  âŒ BROWSERBASE_API_KEY not referenced"
            FAIL=$((FAIL + 1))
          fi

          if grep -rq "BROWSERBASE_PROJECT_ID" src/ 2>/dev/null; then
            echo "  âœ… BROWSERBASE_PROJECT_ID referenced"
            PASS=$((PASS + 1))
          else
            echo "  âŒ BROWSERBASE_PROJECT_ID not referenced"
            FAIL=$((FAIL + 1))
          fi

          echo ""
          echo "Results: $PASS passed, $FAIL failed"
          [ "$FAIL" -eq 0 ] || exit 1

      # â”€â”€ 4. Stagehand SDK methods used â”€â”€
      - name: "Check: Stagehand SDK methods (act, extract, agent, observe)"
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== Stagehand SDK Method Usage ==="
          USED=0; TOTAL=4

          check_method() {
            COUNT=$(grep -r "$1" src/ --include="*.ts" --include="*.tsx" | wc -l | tr -d ' ')
            if [ "$COUNT" -gt 0 ]; then
              echo "  âœ… $1() â€” used $COUNT times"
              USED=$((USED + 1))
              grep -rn "$1" src/ --include="*.ts" | head -2 | while read -r line; do
                echo "     â†³ $line"
              done
            else
              echo "  âš ï¸  $1() â€” not used"
            fi
          }

          check_method "\.extract("
          check_method "\.act("
          check_method "\.agent("
          check_method "\.observe("

          echo ""
          echo "  SDK methods used: $USED/$TOTAL"
          # extract() is required minimum
          if grep -rq "\.extract(" src/ --include="*.ts"; then
            echo "  âœ… extract() present (minimum required)"
          else
            echo "  âŒ extract() not found â€” core scraping won't work"
            exit 1
          fi

      # â”€â”€ 5. Zod schemas for extraction â”€â”€
      - name: "Check: Zod schemas used with extract()"
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== Zod Schema Usage ==="

          if grep -rq "z\.\|zod\|ZodSchema\|z\.object\|z\.string\|z\.array" src/lib/engine/ 2>/dev/null; then
            echo "  âœ… Zod schemas found in engine module"
            grep -rn "z\.object\|z\.string\|z\.array\|z\.number" src/lib/engine/ --include="*.ts" | head -5 | while read -r line; do
              echo "     â†³ $line"
            done
          else
            echo "  âš ï¸  No Zod schemas in engine â€” extract() works best with schemas"
          fi

          if grep -rq "schema.*z\.\|z\..*schema\|instruction.*extract\|extract.*instruction" src/ --include="*.ts" 2>/dev/null; then
            echo "  âœ… extract() configured with instruction or schema"
          fi

      # â”€â”€ 6. Browserbase session management â”€â”€
      - name: "Check: Browserbase session lifecycle"
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== Session Management ==="
          FILE="src/lib/browser/session.ts"

          if [ ! -f "$FILE" ]; then
            echo "  âŒ session.ts not found"
            exit 1
          fi

          FEATURES=0

          if grep -q "createSession\|Browserbase" "$FILE"; then
            echo "  âœ… Session creation"
            FEATURES=$((FEATURES + 1))
          fi

          if grep -q "export" "$FILE"; then
            echo "  âœ… Functions exported"
            FEATURES=$((FEATURES + 1))
          fi

          if grep -q "@browserbasehq/sdk\|@browserbasehq" "$FILE"; then
            echo "  âœ… Imports Browserbase SDK"
            FEATURES=$((FEATURES + 1))
          fi

          echo ""
          echo "  Features: $FEATURES/3"

      # â”€â”€ 7. Screenshot capture â”€â”€
      - name: "Check: screenshot capture during browsing"
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== Screenshot Capture ==="

          if grep -rq "screenshot\|Screenshot\|page\.screenshot\|captureScreenshot" src/ --include="*.ts" 2>/dev/null; then
            echo "  âœ… Screenshot capture found"
            grep -rn "screenshot\|Screenshot" src/lib/ --include="*.ts" | head -5 | while read -r line; do
              echo "     â†³ $line"
            done
          else
            echo "  âš ï¸  No screenshot capture â€” trace timeline will lack visuals"
          fi

      # â”€â”€ 8. Page navigation â”€â”€
      - name: "Check: page navigation (goto/navigate)"
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== Page Navigation ==="

          if grep -rq "\.goto(\|\.navigate(\|page\.goto\|stagehand.*goto\|\.page\.goto" src/ --include="*.ts" 2>/dev/null; then
            echo "  âœ… Page navigation found"
            grep -rn "\.goto(" src/lib/ --include="*.ts" | head -3 | while read -r line; do
              echo "     â†³ $line"
            done
          else
            echo "  âš ï¸  No explicit page.goto() â€” Stagehand may handle navigation internally"
          fi

      # â”€â”€ 9. Recovery uses agent() â”€â”€
      - name: "Check: recovery module uses Stagehand agent()"
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== Recovery with Stagehand Agent ==="
          FILE="src/lib/engine/recovery.ts"

          if [ ! -f "$FILE" ]; then
            echo "  âŒ recovery.ts not found"
            exit 1
          fi

          STRATEGIES=0

          if grep -q "\.agent(" "$FILE"; then
            echo "  âœ… Strategy: stagehand.agent() â€” autonomous recovery"
            STRATEGIES=$((STRATEGIES + 1))
          fi

          if grep -q "\.act(" "$FILE"; then
            echo "  âœ… Strategy: stagehand.act() â€” targeted actions"
            STRATEGIES=$((STRATEGIES + 1))
          fi

          if grep -q "\.extract(" "$FILE"; then
            echo "  âœ… Strategy: stagehand.extract() â€” refined extraction"
            STRATEGIES=$((STRATEGIES + 1))
          fi

          echo ""
          echo "  Recovery strategies: $STRATEGIES/3"
          [ "$STRATEGIES" -ge 1 ] || { echo "  âŒ No recovery strategies implemented"; exit 1; }

      # â”€â”€ 10. Model configuration â”€â”€
      - name: "Check: LLM model configuration"
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== LLM Model Config ==="

          if grep -rq "gpt-4o\|openai/gpt-4o\|modelName\|model:" src/lib/browser/ --include="*.ts" 2>/dev/null; then
            echo "  âœ… Model configured in browser/Stagehand setup"
            grep -rn "gpt-4o\|model" src/lib/browser/ --include="*.ts" | head -3 | while read -r line; do
              echo "     â†³ $line"
            done
          else
            echo "  âš ï¸  No explicit model configuration â€” Stagehand will use defaults"
          fi

      # â”€â”€ 11. TypeScript â”€â”€
      - name: "Check: TypeScript compiles"
        working-directory: ${{ env.WORKING_DIR }}
        run: npx tsc --noEmit
        env:
          BROWSERBASE_API_KEY: ci_placeholder
          BROWSERBASE_PROJECT_ID: ci_placeholder
          OPENAI_API_KEY: ci_placeholder
          REDIS_URL: redis://localhost:6379
          WANDB_API_KEY: ci_placeholder
          WEAVE_PROJECT: webscout
          NEXT_PUBLIC_APP_URL: http://localhost:3000

      # â”€â”€ Summary â”€â”€
      - name: "Browserbase & Stagehand Verification Summary"
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  Browserbase & Stagehand â€” Verified             â•‘"
          echo "â•‘                                                 â•‘"
          echo "â•‘  âœ“ @browserbasehq/stagehand installed           â•‘"
          echo "â•‘  âœ“ @browserbasehq/sdk installed                 â•‘"
          echo "â•‘  âœ“ env: 'BROWSERBASE' configured                â•‘"
          echo "â•‘  âœ“ extract() for data scraping                  â•‘"
          echo "â•‘  âœ“ act() for targeted actions                   â•‘"
          echo "â•‘  âœ“ agent() for autonomous recovery              â•‘"
          echo "â•‘  âœ“ Zod schemas for structured extraction        â•‘"
          echo "â•‘  âœ“ Screenshot capture in traces                 â•‘"
          echo "â•‘                                                 â•‘"
          echo "â•‘  ğŸ”— https://www.stagehand.dev/                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
